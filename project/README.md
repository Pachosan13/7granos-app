# 7 Granos - Sistema de Gesti√≥n Empresarial

Aplicaci√≥n web moderna para gesti√≥n empresarial construida con Vite, React, TypeScript y Supabase. Incluye sistema de roles y multi-sucursal.

## üöÄ Caracter√≠sticas

- **Autenticaci√≥n**: Magic Links con Supabase Auth
- **Roles y Permisos**: Admin, Contador, Gerente con acceso diferenciado
- **Multi-sucursal**: Gesti√≥n de m√∫ltiples ubicaciones (El Cangrejo, San Francisco, Costa del Este, Museo)
- **Rutas protegidas**: Sistema de autenticaci√≥n robusto
- **UI moderna**: Dise√±o limpio con TailwindCSS personalizado
- **Multimodular**: Planilla, Contabilidad y Administraci√≥n
- **TypeScript**: Tipado completo para mejor DX
- **Responsive**: Adaptable a todos los dispositivos

## üõ†Ô∏è Stack Tecnol√≥gico

- **Frontend**: Vite + React 18 + TypeScript
- **Estilos**: TailwindCSS con colores personalizados
- **Enrutamiento**: React Router v6
- **Backend**: Supabase (Auth + Database)
- **Iconos**: Lucide React

## üé® Colores de Marca

- `bean`: #2B2B29 (texto principal)
- `sand`: #E5DCCF (fondo principal)
- `off`: #F5F1EA (fondos secundarios)
- `accent`: #A9CAEE (acentos y botones)
- `slate7g`: #4F5860 (textos secundarios)

## üö¶ Instalaci√≥n y Configuraci√≥n

### 1. Configurar Supabase

1. Crea un nuevo proyecto en [Supabase](https://app.supabase.com)
2. Ve a `Settings` > `API`
3. Copia tu `Project URL` y `anon public key`

### 2. Configurar Base de Datos

1. Ve a `SQL Editor` en tu proyecto de Supabase
2. Ejecuta el archivo `supabase/sql/roles_schema.sql` (crea tablas y sucursales)
3. Ejecuta el archivo `supabase/sql/roles_policies.sql` (configura seguridad RLS)
4. **NUEVO**: Ejecuta el archivo `supabase/sql/import_schema.sql` (sistema de importaci√≥n)
5. **NUEVO**: Ejecuta el archivo `supabase/sql/import_policies.sql` (pol√≠ticas de importaci√≥n)

### 3. Configurar Supabase Storage

1. Ve a `Storage` en tu proyecto de Supabase
2. Crea un nuevo bucket llamado `uploads`
3. Configura las pol√≠ticas de acceso ejecutando estos comandos en el SQL Editor:
   ```sql
   -- Permitir subida de archivos a usuarios autenticados en el bucket 'uploads'
   create policy "Authenticated users can upload files" on storage.objects
     for insert with check (bucket_id = 'uploads' AND auth.uid() = owner);
   
   -- Permitir lectura de archivos a usuarios autenticados en el bucket 'uploads'
   create policy "Authenticated users can view files" on storage.objects
     for select using (bucket_id = 'uploads' AND auth.uid() = owner);
   
   -- Permitir actualizaci√≥n de archivos a usuarios autenticados en el bucket 'uploads'
   create policy "Authenticated users can update files" on storage.objects
     for update using (bucket_id = 'uploads' AND auth.uid() = owner);
   
   -- Permitir eliminaci√≥n de archivos a usuarios autenticados en el bucket 'uploads'
   create policy "Authenticated users can delete files" on storage.objects
     for delete using (bucket_id = 'uploads' AND auth.uid() = owner);
   ```

### 4. Variables de Entorno

1. Copia `.env.example` a `.env.local`:
   ```bash
   cp .env.example .env.local
   ```

2. Completa con tus credenciales de Supabase:
   ```env
   VITE_SUPABASE_URL=https://tu-proyecto.supabase.co
   VITE_SUPABASE_ANON_KEY=tu-clave-anonima-aqui
   ```

### 5. Instalaci√≥n

```bash
# Instalar dependencias
pnpm install

# Iniciar servidor de desarrollo
pnpm dev
```

### 6. Configurar Usuarios y Roles

Para que un usuario pueda acceder al sistema:

1. **Crear usuario en Supabase Auth**:
   - Ve a `Authentication > Users` en tu dashboard de Supabase
   - Haz clic en "Invite a user" o "Add user"
   - Ingresa email y contrase√±a temporal
   - El usuario puede cambiar su contrase√±a usando la recuperaci√≥n

2. **Crear perfil de usuario** en la tabla `user_profile`:
   ```sql
   INSERT INTO public.user_profile (user_id, rol) 
   VALUES ('uuid-del-usuario', 'admin'); -- o 'contador', 'gerente'
   ```

3. **Asignar sucursales** (solo para gerentes, admin/contador ven todas):
   ```sql
   INSERT INTO public.user_sucursal (user_id, sucursal_id) 
   VALUES ('uuid-del-usuario', 'uuid-de-sucursal');
   ```

4. **Obtener UUID del usuario**: En `Authentication > Users` en Supabase dashboard

## üìÅ Estructura del Proyecto

```
src/
‚îú‚îÄ‚îÄ components/          # Componentes reutilizables
‚îÇ   ‚îú‚îÄ‚îÄ Header.tsx      # Header con logo y logout
‚îÇ   ‚îú‚îÄ‚îÄ Sidebar.tsx     # Navegaci√≥n lateral
‚îÇ   ‚îú‚îÄ‚îÄ SucursalSwitcher.tsx # Selector de sucursal
‚îÇ   ‚îú‚îÄ‚îÄ Layout.tsx      # Layout principal
‚îÇ   ‚îú‚îÄ‚îÄ ProtectedRoute.tsx # Rutas protegidas
‚îÇ   ‚îî‚îÄ‚îÄ SupabaseBanner.tsx # Banner de configuraci√≥n
‚îú‚îÄ‚îÄ context/            # Contextos de React
‚îÇ   ‚îî‚îÄ‚îÄ AuthOrgContext.tsx # Contexto de auth + organizaci√≥n
‚îú‚îÄ‚îÄ hooks/              # Custom hooks
‚îÇ   ‚îî‚îÄ‚îÄ useAuth.tsx     # Hook de autenticaci√≥n
‚îú‚îÄ‚îÄ lib/                # Utilidades y configuraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ supabase.ts     # Cliente de Supabase
‚îÇ   ‚îú‚îÄ‚îÄ session.ts      # Gesti√≥n de sesiones
‚îÇ   ‚îú‚îÄ‚îÄ org.ts          # Funciones organizacionales
‚îÇ   ‚îî‚îÄ‚îÄ format.ts       # Funciones de formato
‚îú‚îÄ‚îÄ pages/              # P√°ginas de la aplicaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ Auth/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ IniciarSesion.tsx
‚îÇ   ‚îú‚îÄ‚îÄ importar/       # Sistema de importaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Planilla.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Contabilidad.tsx
‚îÇ   ‚îú‚îÄ‚îÄ Tablero.tsx
‚îÇ   ‚îú‚îÄ‚îÄ Planilla.tsx
‚îÇ   ‚îú‚îÄ‚îÄ Contabilidad.tsx
‚îÇ   ‚îî‚îÄ‚îÄ Administracion.tsx
‚îú‚îÄ‚îÄ services/           # Servicios externos
‚îÇ   ‚îî‚îÄ‚îÄ invu.ts         # Mock de integraci√≥n INVU
‚îú‚îÄ‚îÄ lib/                # Utilidades y configuraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ csv/            # Procesamiento CSV
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ parse.ts
‚îÇ   ‚îú‚îÄ‚îÄ storage/        # Gesti√≥n de archivos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ saveUpload.ts
‚îú‚îÄ‚îÄ App.tsx             # Componente principal
‚îú‚îÄ‚îÄ supabase/sql/       # Scripts SQL para Supabase
‚îÇ   ‚îú‚îÄ‚îÄ roles_schema.sql # Schema de roles y sucursales
‚îÇ   ‚îú‚îÄ‚îÄ roles_policies.sql # Pol√≠ticas de seguridad RLS
‚îÇ   ‚îú‚îÄ‚îÄ import_schema.sql # Schema de importaci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ import_policies.sql # Pol√≠ticas de importaci√≥n
‚îî‚îÄ‚îÄ main.tsx            # Punto de entrada
```

## üè¢ Sistema de Roles y Sucursales

### Roles Disponibles

- **Admin**: Acceso completo a todas las sucursales y funcionalidades
- **Contador**: Acceso a todas las sucursales, enfoque en contabilidad
- **Gerente**: Acceso limitado a sucursales asignadas espec√≠ficamente

### Sucursales

- **El Cangrejo**
- **San Francisco** 
- **Costa del Este**
- **Museo**

### L√≥gica de Permisos

- Los usuarios **Admin** y **Contador** pueden ver todas las sucursales autom√°ticamente
- Los usuarios **Gerente** solo ven las sucursales que tienen asignadas en `user_sucursal`
- El selector de sucursal en el header permite cambiar entre ubicaciones permitidas
- Todas las vistas futuras filtrar√°n datos seg√∫n la sucursal seleccionada

## üîê Autenticaci√≥n

La aplicaci√≥n utiliza **Email + Contrase√±a** de Supabase para autenticaci√≥n:

1. El usuario ingresa su email y contrase√±a
2. El sistema valida las credenciales con Supabase Auth
3. Si olvida la contrase√±a, puede usar la recuperaci√≥n por email
4. Todas las rutas principales est√°n protegidas
5. Despu√©s del login, se cargan el perfil y sucursales del usuario

### Configuraci√≥n de Supabase Auth

En tu proyecto de Supabase, ve a **Authentication > Settings**:

1. **Habilitar Email + Password**: Aseg√∫rate de que est√© activado
2. **Site URL**: Configura tu dominio local (ej: `http://localhost:5173`) para que funcione el `redirectTo` de recuperaci√≥n
3. **Redirect URLs**: Agrega `http://localhost:5173/auth/restablecer` para la recuperaci√≥n de contrase√±a

### Flujo de Recuperaci√≥n de Contrase√±a

1. Usuario va a `/auth/recuperar`
2. Ingresa su email y recibe un enlace por correo
3. El enlace lo lleva a `/auth/restablecer` con una sesi√≥n temporal
4. Puede establecer una nueva contrase√±a
5. Redirige a `/auth/iniciar-sesion` para entrar con la nueva contrase√±a

## üß© Utilidades Incluidas

### Formateo de Moneda
```typescript
import { formatCurrencyUSD } from '@/lib/format';
formatCurrencyUSD(1234.56); // "$1,234.56"
```

### Formateo de Fecha
```typescript
import { formatDateDDMMYYYY } from '@/lib/format';
formatDateDDMMYYYY(new Date()); // "25/08/2025"
```

### Contexto Organizacional
```typescript
import { useAuthOrg } from '@/context/AuthOrgContext';

const { user, profile, sucursales, sucursalSeleccionada } = useAuthOrg();
```

## üéØ Rutas Disponibles

- **P√∫blicas**: 
  - `/auth/iniciar-sesion` - P√°gina de login
  - `/auth/crear-cuenta` - Registro de usuarios
  - `/auth/recuperar` - Recuperaci√≥n de contrase√±a
  - `/auth/restablecer` - Restablecer contrase√±a
- **Privadas** (requieren autenticaci√≥n):
  - `/` - Tablero principal
  - `/payroll` - Gesti√≥n de planillas
  - `/gl` - Contabilidad general
  - `/importar/planilla` - Importar CSV de planillas
  - `/importar/contabilidad` - Importar CSV de ventas/compras
  - `/admin` - Administraci√≥n del sistema

## üìä Sistema de Importaci√≥n CSV

### Caracter√≠sticas
- **Importaci√≥n de planillas**: CSV con columnas empleado, codigo, monto (opcional: qty, centro)
- **Importaci√≥n de ventas**: CSV con columnas fecha, sucursal, total, propinas, itbms, num_transacciones
- **Importaci√≥n de compras**: CSV con columnas proveedor, factura, fecha, subtotal, itbms, total
- **Vista previa**: Muestra las primeras 100 filas y estad√≠sticas
- **Validaci√≥n**: Verifica columnas requeridas antes de procesar
- **Storage**: Archivos guardados en Supabase Storage con estructura organizada
- **Manifiestos**: JSON con metadatos de cada importaci√≥n
- **Log de operaciones**: Registro completo de todas las importaciones

### Sincronizaci√≥n INVU (Mock)
- **API simulada**: Genera datos de prueba para ventas y compras
- **Cursor incremental**: Sistema de seguimiento por dataset
- **Log de sincronizaci√≥n**: Registro de todas las operaciones API
- **Rango de fechas**: Sincronizaci√≥n por per√≠odos espec√≠ficos

### Estructura de Storage
```
uploads/
‚îú‚îÄ‚îÄ {sucursalId}/
‚îÇ   ‚îú‚îÄ‚îÄ planilla/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ {YYYY}/{MM}/{timestamp}-{slug}.csv
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ {YYYY}/{MM}/{timestamp}-{slug}.manifest.json
‚îÇ   ‚îú‚îÄ‚îÄ ventas/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ {YYYY}/{MM}/{timestamp}-{slug}.csv
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ {YYYY}/{MM}/{timestamp}-{slug}.manifest.json
‚îÇ   ‚îî‚îÄ‚îÄ compras/
‚îÇ       ‚îî‚îÄ‚îÄ {YYYY}/{MM}/{timestamp}-{slug}.csv
‚îÇ       ‚îî‚îÄ‚îÄ {YYYY}/{MM}/{timestamp}-{slug}.manifest.json
```

## üì± Dise√±o Responsivo

La aplicaci√≥n est√° optimizada para:
- üì± **Mobile**: < 768px
- üìü **Tablet**: 768px - 1024px  
- üñ•Ô∏è **Desktop**: > 1024px

## ‚ö° Scripts Disponibles

```bash
pnpm dev      # Servidor de desarrollo
pnpm build    # Build para producci√≥n
pnpm preview  # Preview del build
pnpm lint     # Linter de c√≥digo
```

## üîß Troubleshooting

### Usuario no puede acceder despu√©s del login
1. Verifica que existe un registro en `user_profile` con el `user_id` correcto
2. Para gerentes, verifica que tiene sucursales asignadas en `user_sucursal`
3. Revisa los logs del navegador para errores de permisos RLS

### "No tienes sucursales asignadas"
- Los usuarios **Admin** y **Contador** deber√≠an ver todas las sucursales autom√°ticamente
- Los usuarios **Gerente** necesitan registros en `user_sucursal`

## ü§ù Contribuir

1. Fork el proyecto
2. Crea tu rama (`git checkout -b feature/nueva-caracteristica`)
3. Commit tus cambios (`git commit -m 'feat: nueva caracter√≠stica'`)
4. Push a la rama (`git push origin feature/nueva-caracteristica`)
5. Abre un Pull Request

## üìÑ Licencia

Este proyecto est√° bajo la Licencia MIT.

---

## üìã Checklist de Configuraci√≥n

- [ ] Proyecto Supabase creado
- [ ] Email + Password habilitado en Supabase Auth
- [ ] Site URL configurada en Supabase Auth Settings
- [ ] Variables de entorno configuradas
- [ ] Scripts SQL ejecutados (`roles_schema.sql` y `roles_policies.sql`)
- [ ] **NUEVO**: Scripts de importaci√≥n ejecutados (`import_schema.sql` y `import_policies.sql`)
- [ ] **NUEVO**: Bucket `uploads` creado en Supabase Storage
- [ ] **NUEVO**: Pol√≠ticas de Storage configuradas
- [ ] Usuario creado en Supabase Auth
- [ ] Perfil creado en `user_profile`
- [ ] Sucursales asignadas (si es gerente)
- [ ] Login exitoso con selector de sucursal visible
- [ ] **NUEVO**: Sistema de importaci√≥n CSV funcionando
- [ ] **NUEVO**: Sincronizaci√≥n mock con INVU operativa
- [ ] **NUEVO**: Reglas de planilla de Panam√° configuradas
- [ ] **NUEVO**: Motor de c√°lculo con aportes patronales
- [ ] **NUEVO**: Reporte de planilla con exportaci√≥n CSV/PDF
- [ ] **NUEVO**: Generaci√≥n de proforma contable

---

**7 Granos** - Sistema de Gesti√≥n Empresarial üåü